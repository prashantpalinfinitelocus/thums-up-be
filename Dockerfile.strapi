FROM node:18-alpine

RUN apk add --no-cache python3 make g++

WORKDIR /srv/app

# Install all dependencies first (including devDependencies for build)
COPY ./strapi/package*.json ./
RUN npm install --legacy-peer-deps

# Copy source code
COPY ./strapi .

# Build the application
RUN npm run build

# Set production environment
ENV NODE_ENV=production

EXPOSE 1337

CMD ["npm", "run", "start"]

